## ORBextractor
### ORB_SLAM2 怎么进行特征点均匀分配？
1. 提取整张图像中的所有特征点。
2. 将特征点分发到不同的块
3. 去除没有特征点的块
4. 如果一个块中有多个特征点，则选取角点的响应直最高的点。（FAST的角点响应为周围像素(3个像素内)与中心像素的像素差的绝对值）


## Tracking

### 匀速模型追踪，TrackReferenceKeyFrame
1. 使用匀速模型推测当前帧的位姿
2. 将上一帧的观测到的地图点投影到当前帧，并在当前帧中搜索匹配点。SearchByProjection()
3. 如果寻找到的匹配点数量太少（<20），则跟踪失败。return
4. 利用匹配到的点，通过pnp优化当前帧位姿。PoseOptimization()
5. 剔除pnp优化中的外点。
6. 如果成功匹配到的地图点数量大于阈值（>10），则跟踪成功

### TrackReferenceKeyFrame()
1. 通过BoW搜索参考帧与当前帧的匹配点。SearchByBoW()
2. 如果匹配点数量小于阈值（<15）,则跟踪失败。return
4. 利用匹配到的点，通过pnp优化当前帧位姿。PoseOptimization()
5. 剔除pnp优化中的外点。
6. 如果成功匹配到的地图点数量大于阈值（>10），则跟踪成功。

### Relocalization()
1. 从
2. 通过BoW在候选关键帧中寻找匹配特征点。DetectRelocalizationCandidates()
3. 如果匹配的特征点数量足够，则使用 EPnP 求解。PnPsolver()
4. 如果在迭代范围内（5次）EPnP 计算出了位姿，则使用 EPnP 中 RANSAC 标定的内点进行 PnP 优化（只优化位姿）。
5. 如果 PnP 求解得到的内点较少（<50），则将参考关键中的地图点投影到当前帧，进重投影匹配（跳过已经通过BoW找到匹配的地图点）。SearchByProjection
6. 如果通过 PnP 和重投影得到的匹配点数量大于阈值（>50），则使用得到的所有匹配点再进行 PnP 优化。
7. 如果 PnP 优化后的结果还行（>30）,但是内点数量还是小于了阈值（<50）,则用更小窗口、更严格的描述子阈值，重新进行第4步的重投影搜索匹配。
8. 对匹配点进行最后一次的 PnP 优化，如果内点数满足了阈值（>50）,则根据当前候选帧进行重定位成功。
9. 如果当前帧对所有候选帧的匹配点（<50）,则重定位失败。

## 函数功能
### SearchByProjection()
SearchByProjection 一共有4种重载函数

1. 根据基线，判断当前帧的运动方向(前进or后退) ？？？
2. 将上一帧地图点投影到当前帧。
   1.根据上一帧的金字塔层级，确定在当前帧中特征点的搜索半径 
   2. 根据运动方向，判断搜索的金字塔层级（近大远小，）
   3. 从找到的特征点点中选取，特征距离最近的特征点作为最佳匹配点
   4. 判断最佳特征匹配点的距离是否小于阈值
   5. 根据旋转一致性，去除错误的匹配（所有匹配的特征点的旋转角度应该相同）

### PoseOptimization()

### DetectRelocalizationCandidates()
1. 找出和当前帧具有公共单词的所有关键帧
2. 计算当前帧与公共单词数较多的关键帧（>最大公共单词数*0.8）的相似度得分。
3. 将关键帧共视程度最高的关键帧分为一组，计算相似度的累计得分。
4. 如果累计得分大于阈值（最大累计得分*0.75），则将关键帧作为重定位候选帧。


### Frame::ExtractORB()


### ORBextractor::ComputeKeyPointsOctTree()


### LoopClosing::ComputeSim3()
<输入：detectLoop()检测到的回环候选整>
1. 通过BoW快速得到当前正与回环候选正之间的特征点比配。
2. 对满足要求的（nmatches>20）关键正匹配进行 sim3 求解（迭代5次）。
3. 如果 sim3 求解成功，使用 sim3 的求解结果，继续寻找特征点匹配（重投影搜索）。
4. 使用新的匹配点，优化对 sim3 进行优化。 Optimizer::OptimizeSim3()。
5. 当优化后的内点数(>20),则得到最终的 sim3 ，否则继续判断下一个候选整。
6. 使用sim3求解的位姿 ，将闭环关键帧及其连接关键帧的所有地图点投影到当前关键帧进行重投影匹配（寻找回环的局部地图中与当前正共视的正）。SearchByProjection()
7. 如果回环的局部地图中与当前帧的匹配地图点数量(>40),则回环成功。

### SearchBySim3()
1. 将当前关键正的中为找到匹配的点投影到候选真中，
2. 判断投影点数的图像范围、深度范围，计算特征点所在的金字塔层数、搜索半径等。
3. 根据特征点距离，在搜索区域内寻找最佳匹配点。
4. 与第1~3步类似，在当前真中寻找候选真的最佳匹配点。
5. 如果两次寻找的到匹配点一致，则匹配正确


### LoopClosing::CorrectLoop()
1. 结束 LocalMapping 线程，防止回环矫正过程中插入新的关键真。
2. 如果正在运行全局BA，将其终止。
3. **更新当前真的对回环的局部地图中的关键正的观察**，因为在计算 sim3 时前关键增加了对闭环局部地图中地图点的观测。
4. ，以当前正经过 sim3 优化后的位姿（相对于回环正的位姿）为基准，**调整当前正的局部地图中的关键正的位姿**。
5. 根据矫正后的关键正位姿，**调整当前正的局部地图中的关键正的位姿**。
6. 将回环正的局部地图中的地图点投影到,当前关键正的局部地图的关键真中，**调整当前正的局部地图中的关键正的对闭环局部地图中地图点的观测**（回环正的地图点经过了多次优化，其位姿更精准）。
7. **更新当前关键正的局部地图中的所有关键真的共视关系**，因为这些关键真的位姿进行更新，并且其观测的地图点也进行了更新。
8. **进行本质图优化**
9. 创建新线程，进行**全局BA**

## PnPsolver
### 迭代次数
PnP的最大迭代次数为RANSAC理论直和给定直的最大值，而且即使制定了最大迭代数，PnPSolver的迭代并不是一次跑完所有的迭代次数，可以有选择的跑n轮，然后根据结果来判定是否继续进行迭代。当然总的迭代次数不能超过给定的最大迭代次数
```C++
   // mRansacProb 置信度（有多大的概率保证n次至少成功一次）；mRansacEpsilon 内点数比例；4 最小集；
   nIterations = ceil(log(1 - mRansacProb) / log(1 - pow(mRansacEpsilon, 4)));  
   
   // nIterations 理论直；mRansacMaxIts 给定直
   mRansacMaxIts = max(1, min(nIterations, mRansacMaxIts)); 
```
### 最小内点数
mRansacMinInliers 

### PnPsolver::iterate()
1. 使用EPnP算法计算相机的位姿
2. 统计内点数量。CheckInliers()
3. 如果内点数达到了最小数量要求，则使用EPnP对所有内点求解位姿（第一次只使用了4个点，这次使用所有内点）。PnPsolver::Refine()
4. 如果 Refine() 得到的内点数量达到要求，则求解成功。

### PnPsolver::compute_pose(),EPnP 求解
1. 求质心（第一个控制点坐标），归一化坐标
2. 使用特征值分解得到三个方向。cvMulTransposed()
3. 对控制点坐标进行SVD分解，并根据SVD分解的特征值和特征向量，计算剩余的三个控制点坐标

### PnPsolver::CheckInliers()
由于 PnP 已知特征点之间的匹配和一张图像中的特征点对应的3D点。因此重投影误差则是将3D点，向没有匹配3D点的图像进行投影，然后根据2D特征点之间的对应关系，计算投影点的像素误差。这里需要注意的是，由于图像金字塔的各层分辨率不同，计算内点时对误差的容忍度也是不同的。对于同样的距离误差，分辨率越高那么其对应的重投影误差越大。
1. 使用EPnP求解的位姿，将3D点投影到图像平面。
2. 根据特征点之间的匹配，计算重投影误差（像素误差）。
3. 如果重投影误差在可接受的范围内，则认为是内点（金字塔层数越高，可接受的误差范围越大）。


## ORBmatcher
ORB_SLAM2 中寻找特征点匹配的方式有三种，分别为： SearchByBoW 、 SearchByProjection 、 SearchBySim3。

- SearchByBoW 使用特征点的词袋模型，根据特征的词vector距离的进行匹配
- SearchByProjection 根据重投影误差进行匹配。SearchByProjection 总共有4种重载函数。
- SearchBySim3 根据与 SearchByProjection 类似，都使用重投影误差进行匹配，只不过一个使用 sim3 求解的位姿进行重投影。